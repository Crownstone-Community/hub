@startuml
participant hub
participant dongle
participant app
participant cloud

dongle --> app : Advertise (device=dongle,\n dongle_mode=setup)
hub -> dongle : Status (mode=setup)
dongle -> hub : Status (mode=setup, hub_mode=false)
hub -> dongle : Set hub mode
dongle -> hub : Status (mode=setup, hub_mode=true)
dongle --> app : Advertise (device=hub_dongle,\n dongle_mode=setup, hub_mode=setup)

hub -> dongle : Get mac address
dongle -> hub : Mac address=A

app -> cloud : Create stone hub dongle
cloud -> cloud : Generate UART key
cloud -> app : Dongle keys
app -> dongle : Perform setup
dongle -> app : Setup complete
dongle --> app: Advertise (device=hub_dongle,\n dongle_mode=normal, hub_mode=setup)
app -> dongle : Set UART key
dongle -> hub : Status (mode=normal, hub_mode=true)

app -> cloud : Create hub (sphere X, token Y)
cloud -> app: Hub created
app -> dongle : Set hub token (sphere X, token Y)
dongle -> hub : Set hub token (sphere X, token Y)
hub -> cloud : Get user tokens, and sphere data, UART key
cloud -> hub : User tokens, and sphere data, UART key
hub -> cloud : My local IP is 10.0.0.134
hub -> dongle : Setup success
dongle --> app : Advertise (device=hub_dongle,\n dongle_mode=normal, hub_mode=normal)
app -> cloud : Get hub IP 
cloud -> app: Hub IP 10.0.0.134
app -> hub : hello world (with user token)
@enduml

